<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#4A90E2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Chidiya Udd">
  <meta name="description" content="Classic Indian touch-based reaction game - Keep your finger down or lift it based on whether the object can fly!">
  <meta name="keywords" content="chidiya udd, bird fly, indian game, reaction game, multiplayer, touch game">
  
  <!-- Content Security Policy for PWA -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' data: blob:;
    media-src 'self' blob:;
    connect-src 'self' https://cdn.jsdelivr.net https://unpkg.com;
    worker-src 'self' blob:;
  ">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="apple-touch-icon" href="icon.png">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Styles -->
  <link rel="stylesheet" href="styles-v2.css">
  
  <title>Chidiya Udd - Bird Fly Game</title>
</head>
<body>
  
  <!-- ==========================================
       HOME SCREEN
       ========================================== -->
  <section id="home-screen" class="screen home-screen active">
    <!-- Decorative floating elements -->
    <div class="floating-decorations">
      <span class="floating-bird bird-1">ğŸ¦</span>
      <span class="floating-bird bird-2">ğŸ¦…</span>
      <span class="floating-bird bird-3">ğŸ•Šï¸</span>
      <span class="floating-cloud cloud-1">â˜ï¸</span>
      <span class="floating-cloud cloud-2">â˜ï¸</span>
    </div>
    
    <div class="screen-content">
      <div class="logo-container">
        <div class="logo-bird">ğŸ¦</div>
      </div>
      
      <h1 class="app-title title">Chidiya Udd</h1>
      <p class="app-tagline">The Classic Bird Fly Game</p>
      
      <div class="menu-buttons">
        <button id="btn-play-offline" class="btn btn-primary btn-lg">
          <span>ğŸ®</span>
          <span>Play Offline</span>
        </button>
        <button id="btn-play-online" class="btn btn-secondary btn-lg">
          <span>ğŸŒ</span>
          <span>Play Online</span>
        </button>
        <button id="btn-finger-shoot" class="btn btn-accent btn-lg">
          <span>ğŸ”«</span>
          <span>Finger Shoot</span>
        </button>
      </div>
      
      <div class="menu-bottom">
        <button id="btn-how-to-play" class="btn btn-outline">
          <span>â“</span>
          <span>How to Play</span>
        </button>
        <button id="btn-settings" class="btn btn-icon">
          âš™ï¸
        </button>
      </div>
    </div>
  </section>
  
  <!-- ==========================================
       PLAYER SELECTION SCREEN
       ========================================== -->
  <section id="player-select-screen" class="screen">
    <div class="screen-content">
      <h2 class="title">Select Players</h2>
      <p class="subtitle">Choose how many players (same device)</p>
      
      <div id="player-grid" class="player-grid">
        <!-- Player count buttons will be generated by JS -->
      </div>
      
      <button id="btn-back-home" class="btn btn-outline">
        â† Back
      </button>
    </div>
  </section>
  
  <!-- ==========================================
       GAME SETUP SCREEN
       ========================================== -->
  <section id="game-setup-screen" class="screen">
    <div class="screen-content">
      <h2 class="title">Get Ready!</h2>
      <p class="subtitle">Place your finger on your circle</p>
      
      <div class="game-area">
        <div id="setup-circles-container" class="circles-container">
          <!-- Player circles will be generated by JS -->
        </div>
      </div>
      
      <div style="display: flex; gap: 16px; margin-top: 24px;">
        <button id="btn-back-select" class="btn btn-outline btn-sm">
          â† Back
        </button>
        <button id="btn-ready" class="btn btn-primary btn-lg btn-disabled">
          Ready to Start!
        </button>
      </div>
    </div>
  </section>
  
  <!-- ==========================================
       GAME SCREEN
       ========================================== -->
  <section id="game-screen" class="screen">
    <!-- Floating Controls (Center-Right) -->
    <div class="game-controls-floating">
      <button id="btn-back-game" class="btn btn-icon btn-floating">â†</button>
      <span id="round-indicator" class="round-indicator-floating">1/15</span>
      <button id="btn-pause" class="btn btn-icon btn-floating">â¸ï¸</button>
    </div>
    
    <div class="game-area">
      <!-- Opponents Scoreboard (Online Mode) -->
      <div id="opponents-container" class="opponents-container hidden"></div>

      <div class="game-center">
        <div id="timer-ring" class="timer-ring">
          <svg viewBox="0 0 200 200">
            <circle class="timer-bg" cx="100" cy="100" r="90"></circle>
            <circle id="timer-progress" class="timer-progress" cx="100" cy="100" r="90"></circle>
          </svg>
          <div id="object-display" class="object-display-container">
            <div id="object-emoji" class="object-emoji">ğŸ¦</div>
            <div id="object-name" class="object-display">PARROT</div>
          </div>
        </div>
      </div>
      
      <div id="game-circles-container" class="circles-container">
        <!-- Player circles will be generated by JS -->
      </div>
    </div>
    
    <!-- Pause Modal -->
    <div id="pause-modal" class="modal-overlay">
      <div class="modal pause-modal">
        <h3 class="modal-title">â¸ï¸ Game Paused</h3>
        <div class="pause-buttons">
          <button id="btn-resume" class="btn btn-primary btn-lg">â–¶ï¸ Resume</button>
          <button id="btn-quit-game" class="btn btn-outline">ğŸ  Quit to Menu</button>
        </div>
      </div>
    </div>
  </section>
  
  <!-- ==========================================
       RESULTS SCREEN
       ========================================== -->
  <section id="results-screen" class="screen">
    <div class="screen-content">
      <h2 class="title">ğŸ‰ Game Over!</h2>
      
      <div class="results-container">
        <div id="leaderboard" class="leaderboard">
          <!-- Leaderboard items will be generated by JS -->
        </div>
      </div>
      
      <div style="display: flex; gap: 16px; margin-top: 32px; flex-wrap: wrap; justify-content: center;">
        <button id="btn-play-again" class="btn btn-primary">
          ğŸ”„ Play Again
        </button>
        <button id="btn-main-menu" class="btn btn-outline">
          ğŸ  Main Menu
        </button>
      </div>
    </div>
    
    <div id="confetti-container" class="confetti-container"></div>
  </section>
  
  <!-- ==========================================
       ONLINE MENU SCREEN
       ========================================== -->
  <section id="online-menu-screen" class="screen">
    <div class="screen-content">
      <h2 class="title">Online Mode</h2>
      <p class="subtitle">Play with friends on different devices</p>
      
      <div class="name-input-section" style="margin-bottom: 24px;">
        <label for="player-name-input" style="display: block; margin-bottom: 8px; font-weight: 600;">Your Name</label>
        <input 
          type="text" 
          id="player-name-input" 
          class="room-code-input" 
          placeholder="Enter your name"
          maxlength="15"
          autocomplete="off"
          style="text-transform: none;"
        >
      </div>
      
      <div class="menu-buttons">
        <button id="btn-create-room" class="btn btn-primary btn-lg">
          <span>ğŸ </span>
          <span>Create Room</span>
        </button>
        <button id="btn-join-room" class="btn btn-secondary btn-lg">
          <span>ğŸšª</span>
          <span>Join Room</span>
        </button>
      </div>
      
      <button id="btn-back-home-online" class="btn btn-outline" style="margin-top: 32px;">
        â† Back
      </button>
    </div>
  </section>
  
  <!-- ==========================================
       CREATE ROOM SCREEN
       ========================================== -->
  <section id="create-room-screen" class="screen">
    <div class="screen-content">
      <h2 class="title">Your Room</h2>
      
      <div class="room-code-display">
        <span class="room-code-label">Room Code</span>
        <span id="display-room-code" class="room-code">------</span>
        <button id="btn-copy-code" class="btn btn-sm btn-outline">
          ğŸ“‹ Copy
        </button>
      </div>
      
      <p id="online-message" class="waiting-message">Creating room...</p>
      <p id="online-error" class="error-message" style="display: none;"></p>
      
      <div id="host-lobby-players" class="players-list">
        <!-- Players will be listed here -->
      </div>
      
      <div style="display: flex; gap: 16px; margin-top: 24px;">
        <button id="btn-cancel-room" class="btn btn-outline">
          Cancel
        </button>
        <button id="btn-start-game" class="btn btn-primary btn-disabled">
          Start Game
        </button>
      </div>
    </div>
  </section>
  
  <!-- ==========================================
       JOIN ROOM SCREEN
       ========================================== -->
  <section id="join-room-screen" class="screen">
    <div class="screen-content">
      <h2 class="title">Join Room</h2>
      <p class="subtitle">Enter the room code</p>
      
      <input 
        type="text" 
        id="room-code-input" 
        class="room-code-input" 
        placeholder="ABCDEF"
        maxlength="6"
        autocomplete="off"
        autocapitalize="characters"
      >
      
      <p id="join-error" class="error-message" style="display: none;"></p>
      
      <div id="join-loading" class="loading-indicator" style="display: none;">
        <div class="spinner"></div>
        <span>Connecting to room...</span>
      </div>
      
      <div style="display: flex; gap: 16px; margin-top: 24px;">
        <button id="btn-back-online-menu" class="btn btn-outline">
          â† Back
        </button>
        <button id="btn-join-submit" class="btn btn-primary">
          Join
        </button>
      </div>
    </div>
  </section>
  
  <!-- ==========================================
       LOBBY SCREEN (for joined players)
       ========================================== -->
    </div>
  </section>

  <!-- ==========================================
       FINGER SHOOT GAME SCREEN
       ========================================== -->
  <section id="finger-shoot-screen" class="screen">
    <div class="finger-shoot-container">
        <!-- Video for processing (hidden) -->
        <video id="input-video" class="input-video" playsinline></video>
        
        <!-- Canvas for drawing game -->
        <canvas id="output-canvas" class="output-canvas"></canvas>
        
        <!-- UI Overlay -->
        <div class="fs-ui-overlay">
            <div class="fs-header">
                <button id="btn-fs-back" class="btn btn-icon">â†</button>
                <div class="fs-score">Score: <span id="fs-score-value">0</span></div>
            </div>
            
            <div id="fs-loading" class="fs-loading">
                <div class="spinner"></div>
                <p>Loading Hand Tracking...</p>
                <p class="fs-hint">Please allow camera access</p>
            </div>
            
            <div id="fs-instructions" class="fs-instructions hidden">
                <div class="fs-instruction-card">
                    <h3>How to Play</h3>
                    <p>1. Make a "Gun" gesture with your hand ğŸ–ï¸â¡ï¸ğŸ”«</p>
                    <p>2. Aim with your index finger â˜ï¸</p>
                    <p>3. Move thumb DOWN to shoot! ğŸ‘‡</p>
                    <button id="btn-fs-start" class="btn btn-primary">Start Game</button>
                </div>
            </div>
            
            <div id="fs-game-over" class="fs-game-over hidden">
                <h2>Game Over!</h2>
                <p>Final Score: <span id="fs-final-score">0</span></p>
                <button id="btn-fs-restart" class="btn btn-primary">Play Again</button>
                <button id="btn-fs-menu" class="btn btn-outline">Back to Menu</button>
            </div>
        </div>
    </div>
  </section>
   
  <!-- ==========================================
       LOBBY SCREEN (for joined players)
       ========================================== -->
  <section id="lobby-screen" class="screen">
    <div class="screen-content">
      <h2 class="title">Waiting Room</h2>
      
      <div id="client-lobby-players" class="players-list">
        <!-- Players will be listed here -->
      </div>
      
      <p class="waiting-message">Waiting for host to start the game...</p>
      
      <button id="btn-leave-room" class="btn btn-outline" style="margin-top: 24px;">
        Leave Room
      </button>
    </div>
  </section>
  
  <!-- ==========================================
       COUNTDOWN OVERLAY
       ========================================== -->
  <div id="countdown-overlay" class="countdown-overlay">
    <span id="countdown-number" class="countdown-number">3</span>
  </div>
  
  <!-- ==========================================
       SETTINGS MODAL
       ========================================== -->
  <div id="settings-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">âš™ï¸ Settings</h3>
        <button class="modal-close">âœ•</button>
      </div>
      
      <div class="settings-group">
        <div class="settings-item">
          <span class="settings-label">
            <span class="settings-icon">ğŸ”Š</span>
            <span>Sound Effects</span>
          </span>
          <div id="toggle-sound" class="toggle active"></div>
        </div>
        
        <div class="settings-item">
          <span class="settings-label">
            <span class="settings-icon">ğŸ“³</span>
            <span>Vibration</span>
          </span>
          <div id="toggle-vibration" class="toggle active"></div>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 24px;">
        <p style="font-size: 0.75rem; color: #9E9E9E;">
          Chidiya Udd v1.0.0<br>
          Made with â¤ï¸
        </p>
      </div>
    </div>
  </div>
  
  <!-- ==========================================
       HOW TO PLAY MODAL
       ========================================== -->
  <div id="how-to-play-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">â“ How to Play</h3>
        <button class="modal-close">âœ•</button>
      </div>
      
      <div class="tutorial-content">
        <div class="tutorial-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <h4>Place Your Finger</h4>
            <p>Each player places and holds their finger on their colored circle.</p>
          </div>
        </div>
        
        <div class="tutorial-step">
          <div class="step-number">2</div>
          <div class="step-content">
            <h4>Watch the Object</h4>
            <p>An object or animal name will appear in the center of the screen.</p>
          </div>
        </div>
        
        <div class="tutorial-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <h4>React Quickly!</h4>
            <p>If the object <strong>CAN FLY</strong>, lift your finger UP. If it <strong>CANNOT FLY</strong>, keep your finger DOWN.</p>
            
            <div class="example-box">
              <div class="example">
                <div class="example-emoji">ğŸ¦…</div>
                <div class="example-label">EAGLE</div>
                <div class="example-action lift">â˜ï¸ LIFT UP</div>
              </div>
              <div class="example">
                <div class="example-emoji">ğŸ„</div>
                <div class="example-label">COW</div>
                <div class="example-action keep">ğŸ‘‡ KEEP DOWN</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="tutorial-step">
          <div class="step-number">4</div>
          <div class="step-content">
            <h4>Score Points</h4>
            <p>Correct action: <strong style="color: #4CAF50">+10 points</strong><br>
            Wrong action: <strong style="color: #F44336">-5 points</strong></p>
          </div>
        </div>
        
        <div class="tutorial-step">
          <div class="step-number">5</div>
          <div class="step-content">
            <h4>Watch Out!</h4>
            <p>Some birds can't fly! ğŸ§ Penguins, ğŸ¦¤ Ostriches, and ğŸ¥ Kiwis are trick items - keep your finger DOWN!</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ==========================================
       SCRIPTS
       ========================================== -->
  
  <!-- PeerJS for multiplayer (loaded from CDN) -->
  <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
  
  <!-- Game Logic -->
  <script src="game-v2.js"></script>
  
  <!-- Multiplayer Logic -->
  <script src="peer-multiplayer.js"></script>
  
  <!-- MediaPipe Hands & Camera Utils -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  
  <!-- Finger Shoot Game Logic -->
  <script src="finger-shoot-game.js"></script>
  
  <!-- Service Worker UN-Registration -->
  <script>
    // UNregister service worker to fix caching issues
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
          for(let registration of registrations) {
            console.log('Unregistering SW:', registration);
            registration.unregister();
          }
        });
      });
    }
    
    // Handle URL parameters (for PWA shortcuts)
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    if (mode === 'offline') {
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('btn-play-offline')?.click();
      });
    } else if (mode === 'online') {
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('btn-play-online')?.click();
      });
    }
    
    // Prevent zoom on double-tap
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e) => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive: false });
    
    // Prevent pinch zoom
    document.addEventListener('gesturestart', (e) => {
      e.preventDefault();
    });
  </script>
</body>
</html>
